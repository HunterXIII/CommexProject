{% extends 'main/base.html' %}
{% load static %}

{% block title %}{{ companion.username }} — Commex{% endblock %}

{% block content %}
<div class="d-flex flex-column vh-100 bg-black">

    <!-- Шапка чата -->
    <div class="border-bottom border-dark-subtle p-3 d-flex align-items-center gap-3">
        <a href="{% url 'chat_list' %}" class="text-white">
            <i class="bi bi-arrow-left fs-3"></i>
        </a>
        <img src="{% if companion.profile_image %}{{ companion.profile_image.url }}{% else %}{% static 'img/default_avatar.png' %}{% endif %}"
            class="rounded-circle" width="44" height="44" alt="">
        <div>
            <h5 class="mb-0 text-white fw-semibold">{{ companion.username }}</h5>
            <small class="text-success">● Онлайн</small>
        </div>
        <div class="ms-auto d-flex align-items-center gap-2">
            <a href="{% url 'delete_chat' chat.id %}" class="btn btn-outline-light btn-sm d-flex align-items-center gap-2">
                <i class="bi bi-trash"></i>
                <span>Удалить чат</span>
            </a>
        </div>
    </div>

    <!-- Сообщения -->
    <div id="messages-container" class="flex-grow-1 overflow-auto px-4 py-3" style="background: #0d0d0d;">
        {% for msg in messages %}
        <div
            class="d-flex {% if msg.sender == request.user %}justify-content-end{% else %}justify-content-start{% endif %} mb-3">
            <div class="message-bubble {% if msg.sender == request.user %}my{% else %}their{% endif %}">
                <div class="text">{{ msg.content }}</div>
                <div class="meta">
                    <span class="time">{{ msg.date_of_sending|time:"H:i" }}</span>
                    {% if msg.sender == request.user %}
                    <span class="checkmarks">
                        {% if msg.is_read %}✓✓{% else %}✓{% endif %}
                    </span>
                    <a href="{% url 'delete_message' msg.id %}" class="text-decoration-none text-muted small ms-2">
                        <i class="bi bi-trash"></i>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="text-center text-muted mt-5">
            <i class="bi bi-chat-dots fs-1 opacity-50"></i>
            <p class="mt-3">Начните общение!</p>
        </div>
        {% endfor %}
    </div>

    <!-- Поле ввода (приклеено снизу) -->
    <div class="border-top border-dark-subtle p-3">
        <form method="post" class="d-flex gap-2">
            {% csrf_token %}
            <input id="message-input" name="content" type="text" class="form-control flex-grow-1" placeholder="Сообщение..."
                autocomplete="off" required autofocus
                style="background: #1e1e1e; border: none; border-radius: 24px; padding: 14px 20px; color: white;">
            <button type="submit"
                class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center"
                style="width: 48px; height: 48px;">
                <i class="bi bi-send-fill"></i>
            </button>
        </form>
    </div>
</div>

<!-- Автоскролл вниз при загрузке -->
<script>
const container = document.getElementById('messages-container');
if (container) {
    container.scrollTop = container.scrollHeight;
}

const messageInput = document.getElementById('message-input');
if (messageInput) {
    messageInput.focus();
    window.addEventListener('focus', () => messageInput.focus());
}
</script>
{% endblock %}