{% extends 'main/base.html' %}
{% load static %}

{% block title %}{{ companion.username }} — Commex{% endblock %}

{% block extra_css %}
<style>
    /* Оптимизируем страницу чата под весь экран и фиксируем нижнюю панель */
    main.container {
        max-width: 1100px;
        padding-left: 0;
        padding-right: 0;
    }

    .chat-wrapper {
        min-height: calc(100vh - 96px);
        display: flex;
        flex-direction: column;
        background: #000;
        border: 1px solid var(--border);
        border-radius: 16px;
        overflow: hidden;
    }

    .chat-messages {
        background: #0d0d0d;
        overflow-y: auto;
    }

    .chat-input-bar {
        position: sticky;
        bottom: 0;
        background: #0d0d0d;
        z-index: 2;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-wrapper">

    <!-- Шапка чата -->
    <div class="border-bottom border-dark-subtle p-3 d-flex align-items-center gap-3">
        <a href="{% url 'chat_list' %}" class="text-white">
            <i class="bi bi-arrow-left fs-3"></i>
        </a>
        <img src="{% if companion.profile_image %}{{ companion.profile_image.url }}{% else %}{% static 'img/default_avatar.jpg' %}{% endif %}"
            class="rounded-circle" width="44" height="44" alt="">
        <div>
            <h5 class="mb-0 text-white fw-semibold">{{ companion.username }}</h5>
            {% if companion.status %}
            <small class="text-success">● Онлайн</small>
            {% else %}
            <small>Не в сети</small>
            {% endif %}
        </div>
        <div class="ms-auto d-flex align-items-center gap-2">
            <a href="{% url 'delete_chat' chat.id %}"
                class="btn btn-outline-light btn-sm d-flex align-items-center gap-2">
                <i class="bi bi-trash"></i>
                <span>Удалить чат</span>
            </a>
        </div>
    </div>

    <!-- Сообщения -->
    <div id="messages-container" class="chat-messages flex-grow-1 px-4 py-3">
        {% for msg in messages %}

        <div class="d-flex {% if msg.sender == request.user %}justify-content-end{% else %}justify-content-start{% endif %} mb-3"
            data-message-id="{{ msg.id }}">

            <div class="message-bubble {% if msg.sender == request.user %}my{% else %}their{% endif %}">
                <div class="text">{{ msg.content }}</div>
                <div class="meta">
                    <span class="time">{{ msg.date_of_sending|time:"H:i" }}</span>
                    {% if msg.sender == request.user %}
                    <span class="checkmarks">
                        {% if msg.is_read %}✓✓{% else %}✓{% endif %}
                    </span>
                    <a href="{% url 'delete_message' msg.id %}" class="btn btn-link p-0 text-decoration-none text-muted small ms-2 message-delete-btn">
                        <i class="bi bi-trash"></i>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="text-center text-muted mt-5">
            <i class="bi bi-chat-dots fs-1 opacity-50"></i>
            <p class="mt-3">Начните общение!</p>
        </div>
        {% endfor %}
    </div>

    <!-- Поле ввода -->
    <div class="chat-input-bar border-top border-dark-subtle p-3">
        <div class="d-flex gap-2">
            <input id="message-input" type="text" class="form-control flex-grow-1" placeholder="Сообщение..."
                autocomplete="off"
                style="background: #1e1e1e; border: none; border-radius: 24px; padding: 14px 20px; color: white;">
            <button id="send-btn"
                class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center"
                style="width: 48px; height: 48px;">
                <i class="bi bi-send-fill"></i>
            </button>
        </div>
    </div>
</div>

<script>
    const chatId = "{{ chat.id }}";
    const currentUser = "{{ request.user.username }}";
    
    const container = document.getElementById("messages-container");
    const input = document.getElementById("message-input");
    const sendBtn = document.getElementById("send-btn");
    
    const socket = new WebSocket(
        (location.protocol === "https:" ? "wss://" : "ws://") +
        location.host + "/ws/chat/" + chatId + "/"
    );
    
    // ======================
    // RECEIVE
    // ======================
    socket.onmessage = (e) => {
        const data = JSON.parse(e.data);
    
        if (data.event === "message_created") {
            addMessage(data);
        }
    
        if (data.event === "message_deleted") {
            removeMessage(data.message_id);
        }
    
        if (data.event === "message_read") {
            markAsRead(data.message_id);
        }
    };
    
    // ======================
    // SEND
    // ======================
    sendBtn.onclick = sendMessage;
    input.addEventListener("keydown", e => {
        if (e.key === "Enter") sendMessage();
    });
    
    function sendMessage() {
        const text = input.value.trim();
        if (!text) return;
    
        socket.send(JSON.stringify({
            type: "send_message",
            message: text
        }));
    
        input.value = "";
    }
    
    // ======================
    // UI
    // ======================
    function addMessage(data) {
        const isMine = data.user === currentUser;
    
        const wrapper = document.createElement("div");
        wrapper.classList.add("d-flex", "mb-3");
        wrapper.classList.add(isMine ? "justify-content-end" : "justify-content-start");
        wrapper.dataset.messageId = data.message_id;
    
        wrapper.innerHTML = `
            <div class="message-bubble ${isMine ? "my" : "their"}">
                <div class="text">${data.message}</div>
                <div class="meta">
                    <span class="time">${data.time}</span>
                    ${isMine ? `
                        <span class="checkmarks">${data.is_read ? "✓✓" : "✓"}</span>
                        <button class="btn btn-link p-0 text-muted small ms-2"
                            onclick="deleteMessage(${data.message_id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    ` : ""}
                </div>
            </div>
        `;
    
        container.appendChild(wrapper);
        container.scrollTop = container.scrollHeight;
    
        if (!isMine) {
            socket.send(JSON.stringify({
                type: "read_message",
                message_id: data.message_id
            }));
        }
    }
    
    function deleteMessage(id) {
        socket.send(JSON.stringify({
            type: "delete_message",
            message_id: id
        }));
    }
    
    function removeMessage(id) {
        const el = container.querySelector(`[data-message-id="${id}"]`);
        if (el) el.remove();
    }
    
    function markAsRead(id) {
        const el = container.querySelector(
            `[data-message-id="${id}"] .checkmarks`
        );
        if (el) el.textContent = "✓✓";
    }
</script>
    
    
    

{% endblock %}