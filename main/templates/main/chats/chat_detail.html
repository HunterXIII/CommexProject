{% extends 'main/base.html' %}
{% load static %}

{% block title %}{{ companion.username }} — Commex{% endblock %}

{% block content %}
<div class="d-flex flex-column vh-100 bg-black">

    <!-- Шапка чата -->
    <div class="border-bottom border-dark-subtle p-3 d-flex align-items-center gap-3">
        <a href="{% url 'chat_list' %}" class="text-white">
            <i class="bi bi-arrow-left fs-3"></i>
        </a>
        <img src="{% if companion.profile_image %}{{ companion.profile_image.url }}{% else %}{% static 'img/default_avatar.jpg' %}{% endif %}"
            class="rounded-circle" width="44" height="44" alt="">
        <div>
            <h5 class="mb-0 text-white fw-semibold">{{ companion.username }}</h5>
            {% if companion.status %}
                <small class="text-success">● Онлайн</small>
            {% else %}
                <small>Не в сети</small>
            {% endif %}
        </div>
        <div class="ms-auto d-flex align-items-center gap-2">
            <a href="{% url 'delete_chat' chat.id %}" class="btn btn-outline-light btn-sm d-flex align-items-center gap-2">
                <i class="bi bi-trash"></i>
                <span>Удалить чат</span>
            </a>
        </div>
    </div>

    <!-- Сообщения -->
    <div id="messages-container" class="flex-grow-1 overflow-auto px-4 py-3" style="background: #0d0d0d;">
        {% for msg in messages %}
        <div class="d-flex {% if msg.sender == request.user %}justify-content-end{% else %}justify-content-start{% endif %} mb-3"
            data-message-id="{{ msg.id }}">
            <div class="message-bubble {% if msg.sender == request.user %}my{% else %}their{% endif %}">
                <div class="text">{{ msg.content }}</div>
                <div class="meta">
                    <span class="time">{{ msg.date_of_sending|time:"H:i" }}</span>
                    {% if msg.sender == request.user %}
                    <span class="checkmarks">
                        {% if msg.is_read %}✓✓{% else %}✓{% endif %}
                    </span>
                    <button type="button"
                        class="btn btn-link p-0 text-decoration-none text-muted small ms-2 message-delete-btn"
                        data-delete-message="true" data-message-id="{{ msg.id }}">
                        <i class="bi bi-trash"></i>
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="text-center text-muted mt-5">
            <i class="bi bi-chat-dots fs-1 opacity-50"></i>
            <p class="mt-3">Начните общение!</p>
        </div>
        {% endfor %}
    </div>

    <!-- Поле ввода -->
    <div class="border-top border-dark-subtle p-3">
        <div class="d-flex gap-2">
            <input id="message-input" type="text" class="form-control flex-grow-1"
                placeholder="Сообщение..." autocomplete="off"
                style="background: #1e1e1e; border: none; border-radius: 24px; padding: 14px 20px; color: white;">
            <button id="send-btn"
                class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center"
                style="width: 48px; height: 48px;">
                <i class="bi bi-send-fill"></i>
            </button>
        </div>
    </div>
</div>

<script>
    const chatId = "{{ chat.id }}";
    const userUsername = "{{ request.user.username }}";

    const messagesContainer = document.getElementById('messages-container');

    if (messagesContainer) {
        const inputField = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');

        // Автоскролл при загрузке
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // WebSocket init
        const chatSocket = new WebSocket(
            (window.location.protocol === "https:" ? "wss://" : "ws://") +
            window.location.host +
            "/ws/chat/" + chatId + "/"
        );

        // Получение сообщения
        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);
            if (data.event === "message_created") {
                addMessageToUI(data.user, data.message, data.message_id);
            } else if (data.event === "message_deleted") {
                removeMessageFromUI(data.message_id);
            }
        };

        chatSocket.onclose = function () {
            console.error("WebSocket closed unexpectedly");
        };

        // Отправка сообщения
        sendBtn.onclick = sendMessage;
        inputField.addEventListener("keydown", (e) => {
            if (e.key === "Enter") sendMessage();
        });

        messagesContainer.addEventListener("click", (e) => {
            const deleteBtn = e.target.closest("[data-delete-message='true']");
            if (!deleteBtn) return;
            const messageId = deleteBtn.dataset.messageId;
            if (messageId) {
                requestDelete(messageId);
            }
        });

        function sendMessage() {
            const message = inputField.value.trim();
            if (!message) return;

            chatSocket.send(JSON.stringify({
                "action": "send_message",
                "message": message
            }));

            inputField.value = "";
        }

        function requestDelete(messageId) {
            chatSocket.send(JSON.stringify({
                "action": "delete_message",
                "message_id": messageId
            }));
        }


        // ➤ Добавление сообщения в интерфейс
        function addMessageToUI(username, message, messageId) {
            const wrapper = document.createElement("div");
            wrapper.classList.add("d-flex", "mb-3");
            wrapper.classList.add(username === userUsername ? "justify-content-end" : "justify-content-start");
            wrapper.dataset.messageId = messageId;

            // delete button only for my messages
            const deleteBtn = username === userUsername
                ? `<button type="button"
                        class="btn btn-link p-0 text-decoration-none text-muted small ms-2"
                        data-delete-message="true" data-message-id="${messageId}">
                        <i class="bi bi-trash"></i>
                   </button>`
                : "";

            wrapper.innerHTML = `
                <div class="message-bubble ${username === userUsername ? "my" : "their"}">
                    <div class="text">${message}</div>
                    <div class="meta">
                        <span class="time">${currentTime()}</span>

                        ${username === userUsername ? `<span class="checkmarks">✓</span>` : ""}
                        ${deleteBtn}
                    </div>
                </div>
            `;

            messagesContainer.appendChild(wrapper);

            // Автоскролл
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeMessageFromUI(messageId) {
            if (!messageId) return;
            const messageEl = messagesContainer.querySelector(`[data-message-id="${messageId}"]`);
            if (messageEl) {
                messageEl.remove();
            }
        }

        function currentTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ":" +
                now.getMinutes().toString().padStart(2, '0');
        }
    }

    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        messageInput.focus();
        window.addEventListener('focus', () => messageInput.focus());
    }

</script>

{% endblock %}
