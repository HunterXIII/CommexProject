{% extends 'main/base.html' %}
{% load static %}

{% block title %}{{ companion.username }} — Commex{% endblock %}

{% block extra_css %}
<style>
    /* Оптимизируем страницу чата под весь экран и фиксируем нижнюю панель */
    main.container {
        max-width: 1100px;
        padding-left: 0;
        padding-right: 0;
    }

    .chat-wrapper {
        min-height: calc(100vh - 96px);
        display: flex;
        flex-direction: column;
        background: #000;
        border: 1px solid var(--border);
        border-radius: 16px;
        overflow: hidden;
    }

    .chat-messages {
        background: #0d0d0d;
        overflow-y: auto;
    }

    .chat-input-bar {
        position: sticky;
        bottom: 0;
        background: #0d0d0d;
        z-index: 2;
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-wrapper">

    <!-- Шапка чата -->
    <div class="border-bottom border-dark-subtle p-3 d-flex align-items-center gap-3">
        <a href="{% url 'chat_list' %}" class="text-white">
            <i class="bi bi-arrow-left fs-3"></i>
        </a>
        <img src="{% if companion.profile_image %}{{ companion.profile_image.url }}{% else %}{% static 'img/default_avatar.jpg' %}{% endif %}"
            class="rounded-circle" width="44" height="44" alt="">
        <div>
            <h5 class="mb-0 text-white fw-semibold">{{ companion.username }}</h5>
            {% if companion.status %}
            <small class="text-success">● Онлайн</small>
            {% else %}
            <small>Не в сети</small>
            {% endif %}
        </div>
        <div class="ms-auto d-flex align-items-center gap-2">
            <a href="{% url 'delete_chat' chat.id %}"
                class="btn btn-outline-light btn-sm d-flex align-items-center gap-2">
                <i class="bi bi-trash"></i>
                <span>Удалить чат</span>
            </a>
        </div>
    </div>

    <!-- Сообщения -->
    <div id="messages-container" class="chat-messages flex-grow-1 px-4 py-3">
        {% for msg in messages %}
        <div
            class="d-flex {% if msg.sender == request.user %}justify-content-end{% else %}justify-content-start{% endif %} mb-3">
            <div class="message-bubble {% if msg.sender == request.user %}my{% else %}their{% endif %}">
                <div class="text">{{ msg.content }}</div>
                <div class="meta">
                    <span class="time">{{ msg.date_of_sending|time:"H:i" }}</span>
                    {% if msg.sender == request.user %}
                    <span class="checkmarks">
                        {% if msg.is_read %}✓✓{% else %}✓{% endif %}
                    </span>
                    <a href="{% url 'delete_message' msg.id %}" class="text-decoration-none text-muted small ms-2">
                        <i class="bi bi-trash"></i>
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="text-center text-muted mt-5">
            <i class="bi bi-chat-dots fs-1 opacity-50"></i>
            <p class="mt-3">Начните общение!</p>
        </div>
        {% endfor %}
    </div>

    <!-- Поле ввода -->
    <div class="chat-input-bar border-top border-dark-subtle p-3">
        <div class="d-flex gap-2">
            <input id="message-input" type="text" class="form-control flex-grow-1" placeholder="Сообщение..."
                autocomplete="off"
                style="background: #1e1e1e; border: none; border-radius: 24px; padding: 14px 20px; color: white;">
            <button id="send-btn"
                class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center"
                style="width: 48px; height: 48px;">
                <i class="bi bi-send-fill"></i>
            </button>
        </div>
    </div>
</div>

<script>
    const chatId = "{{ chat.id }}";
    const userUsername = "{{ request.user.username }}";

    const messagesContainer = document.getElementById('messages-container');

    if (messagesContainer) {
        const inputField = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');

        // Автоскролл при загрузке
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        // WebSocket init
        const chatSocket = new WebSocket(
            (window.location.protocol === "https:" ? "wss://" : "ws://") +
            window.location.host +
            "/ws/chat/" + chatId + "/"
        );

        // Получение сообщения
        chatSocket.onmessage = function (e) {
            const data = JSON.parse(e.data);

            // data.user, data.message, data.message_id
            addMessageToUI(data.user, data.message, data.message_id);
        };

        chatSocket.onclose = function () {
            console.error("WebSocket closed unexpectedly");
        };

        // Отправка сообщения
        sendBtn.onclick = sendMessage;
        inputField.addEventListener("keydown", (e) => {
            if (e.key === "Enter") sendMessage();
        });

        function sendMessage() {
            const message = inputField.value.trim();
            if (!message) return;

            chatSocket.send(JSON.stringify({
                "message": message
            }));

            inputField.value = "";
        }


        // ➤ Добавление сообщения в интерфейс
        function addMessageToUI(username, message, messageId) {
            const wrapper = document.createElement("div");
            wrapper.classList.add("d-flex", "mb-3");
            wrapper.classList.add(username === userUsername ? "justify-content-end" : "justify-content-start");

            // delete button only for my messages
            const deleteBtn = username === userUsername
                ? `<a href="/message/${messageId}/delete" 
                    class="text-decoration-none text-muted small ms-2">
                        <i class="bi bi-trash"></i>
                </a>`
                : "";

            wrapper.innerHTML = `
                <div class="message-bubble ${username === userUsername ? "my" : "their"}">
                    <div class="text">${message}</div>
                    <div class="meta">
                        <span class="time">${currentTime()}</span>

                        ${username === userUsername ? `<span class="checkmarks">✓</span>` : ""}
                        ${deleteBtn}
                    </div>
                </div>
            `;

            messagesContainer.appendChild(wrapper);

            // Автоскролл
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function currentTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ":" +
                now.getMinutes().toString().padStart(2, '0');
        }
    }

    const messageInput = document.getElementById('message-input');
    if (messageInput) {
        messageInput.focus();
        window.addEventListener('focus', () => messageInput.focus());
    }

</script>

{% endblock %}